//
//  StreamMockServer.swift
//  StreamMockServer
//
//  Created by Alexey Alter Pesotskiy  on 3/3/22.
//  Copyright Â© 2022 Stream.io Inc. All rights reserved.
//


@testable import StreamChat
@testable import StreamChatUI
import Swifter

final class StreamMockServer {
    
    private var server: HttpServer = HttpServer()
    private weak var session: WebSocketSession!
    private var endpoint: Endpoint<EmptyResponse>!
    
    func webSocketClosure() -> ((HttpRequest) -> HttpResponse) {
        websocket(text: { [weak self] (_, text) in
            print("TESTME:MESSAGE")
            print(text)
        }, connected: { [weak self] session in
            print("TESTME:CONNECTION")
            self?.session = session
            self?.onConnected()
        }, disconnected: { [weak self] _ in
            print("TESTME:DISCONNECT")
            self?.session = nil
        })
    }
    
    func onConnected() {
        session.writeText("""
        { "type": "health.check", "connection_id": "6203b82e-0a05-1935-0000-000006cfc104", "cid": "*", "me": { "id": "luke_skywalker", "role": "user", "created_at": "2020-12-07T11:36:47.059906Z", "updated_at": "2022-03-03T19:19:37.870911Z", "last_active": "2022-03-03T19:53:59.386699142Z", "banned": false, "online": true, "invisible": false, "devices": [ { "push_provider": "apn", "id": "82de504f9a7c1a4a4b85cface945e98d5d6078a074831a27643bbbca73eec132", "created_at": "2022-03-01T15:23:51.369355Z", "user_id": "luke_skywalker" }, { "push_provider": "apn", "id": "fefdb293085df165fc47270d1b72d607739fc26e8c193a1a48bd94e22ee116dd", "created_at": "2022-02-28T09:58:16.742843Z", "user_id": "luke_skywalker" }, { "push_provider": "apn", "id": "7a58e2b4d01353901cc1f3c3c4a9048057fd70eb184b8e3b7260bd01218f048b", "created_at": "2022-02-25T15:25:08.854183Z", "user_id": "luke_skywalker" }, { "push_provider": "apn", "id": "179184f865b17fe4f4f49f70c197a24bb1c26259da1daa1b8b24a33dd4a00762", "created_at": "2022-02-23T08:02:13.079424Z", "user_id": "luke_skywalker" } ] } }
        """)
    }
    
    func start(port: UInt16) {
        do {
            try server.start(port)
            print("Server status: \(server.state). Port: \(port)")
        } catch {
            print("Server start error: \(error)")
        }
    }
    
    func stop() {
        server.stop()
    }

    func configure() {
        server["/connect"] = webSocketClosure()
        server["/channels/messaging/:channel_id/read"] = { request in
            .ok(.text("""
            { "event": { "type": "message.read", "cid": "messaging:4101B3B5-0", "channel_id": "71150333-D", "channel_type": "messaging", "user": { "id": "luke_skywalker", "role": "user", "created_at": "2020-12-07T11:36:47.059906Z", "updated_at": "2022-03-08T15:30:07.960068Z", "last_active": "2022-03-08T16:23:31.223911Z", "banned": false, "online": true, "extraData": {}, "image": "https://vignette.wikia.nocookie.net/starwars/images/2/20/LukeTLJ.jpg", "testing-this": 3.14, "testing": false, "image_url": "https://vignette.wikia.nocookie.net/starwars/images/2/20/LukeTLJ.jpg", "extra_data": {}, "birthland": "Tatooine", "yetAnotherField": "40", "name": "Luke Skywalker" }, "created_at": "2022-03-08T16:32:28.989899197Z" }, "duration": "16.53ms" }
            """))
        }
        server["/channels/messaging/:channel_id/message"] = { request in
            let json = String(bytes: request.body, encoding: .utf8)!.json
            let message = (json["message"] as! Dictionary<String, Any>)["text"] ?? "default message"
            return .ok(.text("""
            { "message": { "id": "8CEC7FFF-3842-4ECC-85EC-9D0B82A6AA58", "text": "\(message)", "html": "<p>\(message)</p>\n", "type": "regular", "user": { "id": "luke_skywalker", "role": "user", "created_at": "2020-12-07T11:36:47.059906Z", "updated_at": "2022-03-08T15:30:07.960068Z", "last_active": "2022-03-08T15:57:33.831192082Z", "banned": false, "online": true, "testing-this": 3.14, "image": "https://vignette.wikia.nocookie.net/starwars/images/2/20/LukeTLJ.jpg", "birthland": "Tatooine", "image_url": "https://vignette.wikia.nocookie.net/starwars/images/2/20/LukeTLJ.jpg", "extra_data": {}, "testing": false, "extraData": {}, "yetAnotherField": "40", "name": "Luke Skywalker" }, "attachments": [], "latest_reactions": [], "own_reactions": [], "reaction_counts": {}, "reaction_scores": {}, "reply_count": 0, "cid": "messaging:4101B3B5-0", "created_at": "2022-03-08T15:57:47.255945Z", "updated_at": "2022-03-08T15:57:47.255945Z", "shadowed": false, "mentioned_users": [], "silent": false, "pinned": false, "pinned_at": null, "pinned_by": null, "pin_expires": null }, "duration": "64.73ms" }
            """))
        }
        server["/channels/messaging/:channel_id/event"] = { request in
            let json = String(bytes: request.body, encoding: .utf8)!.json
            let event = json["event"] as! Dictionary<String, Any>
            if event["type"] as! String == "typing.start" {
                return .ok(.text("""
                { "event": { "type": "typing.start", "cid": "messaging:71150353-D", "channel_id": "71150333-D", "channel_type": "messaging", "user": { "id": "luke_skywalker", "role": "user", "created_at": "2020-12-07T11:36:47.059906Z", "updated_at": "2022-03-08T10:24:54.481883Z", "last_active": "2022-03-08T10:28:13.311924202Z", "banned": false, "online": true, "image_url": "https://vignette.wikia.nocookie.net/starwars/images/2/20/LukeTLJ.jpg", "extraData": {}, "testing-this": 3.14, "yetAnotherField": "40", "extra_data": {}, "image": "https://bit.ly/2TIt8NR", "testing": false, "birthland": "Tatooine", "name": "Luke Skywalker" }, "created_at": "2022-03-08T10:29:07.915394545Z" }, "duration": "4.61ms" }
                """))
            } else if event["type"] as! String == "typing.stop" {
                return .ok(.text("""
                { "event": { "type": "typing.start", "cid": "messaging:71150353-D", "channel_id": "71150333-D", "channel_type": "messaging", "user": { "id": "luke_skywalker", "role": "user", "created_at": "2020-12-07T11:36:47.059906Z", "updated_at": "2022-03-08T10:24:54.481883Z", "last_active": "2022-03-08T10:28:13.311924202Z", "banned": false, "online": true, "image_url": "https://vignette.wikia.nocookie.net/starwars/images/2/20/LukeTLJ.jpg", "extraData": {}, "testing-this": 3.14, "yetAnotherField": "40", "extra_data": {}, "image": "https://bit.ly/2TIt8NR", "testing": false, "birthland": "Tatooine", "name": "Luke Skywalker" }, "created_at": "2022-03-08T10:29:07.915394545Z" }, "duration": "4.61ms" }
                """))
            } else {
                return .ok(.text("dunno"))
            }
        }
        server["/channels/messaging/:channel_id/query"] = { _ in
            .ok(.text("""
            { "channel": { "id": "71150353-D", "type": "messaging", "cid": "messaging:71150353-D", "last_message_at": "2021-12-14T13:49:23.57Z", "created_at": "2021-07-26T06:38:29.34163Z", "updated_at": "2021-12-14T13:50:31.893151Z", "created_by": { "id": "luke_skywalker", "role": "user", "created_at": "2020-12-07T11:36:47.059906Z", "updated_at": "2022-03-08T10:24:54.481883Z", "last_active": "2022-03-08T10:12:36.42996Z", "banned": false, "online": true, "extra_data": {}, "image": "https://bit.ly/2TIt8NR", "yetAnotherField": "40", "image_url": "https://vignette.wikia.nocookie.net/starwars/images/2/20/LukeTLJ.jpg", "testing": false, "birthland": "Tatooine", "extraData": {}, "name": "Luke Skywalker", "testing-this": 3.14 }, "frozen": false, "disabled": false, "member_count": 2, "config": { "created_at": "2021-03-01T19:26:18.406502Z", "updated_at": "2021-09-01T17:42:21.99149Z", "name": "messaging", "typing_events": true, "read_events": true, "connect_events": true, "search": true, "reactions": true, "replies": true, "quotes": true, "mutes": true, "uploads": true, "url_enrichment": true, "custom_events": true, "push_notifications": true, "message_retention": "infinite", "max_message_length": 5000, "automod": "AI", "automod_behavior": "block", "blocklist": "profanity_en_2020_v1", "blocklist_behavior": "block", "automod_thresholds": { "explicit": { "flag": 0.85, "block": 0.9 }, "spam": { "flag": 0.85, "block": 0.9 }, "toxic": { "flag": 0.85, "block": 0.9 } }, "commands": [ { "name": "giphy", "description": "Post a random gif to the channel", "args": "[text]", "set": "fun_set" } ] }, "own_capabilities": [ "send-links", "freeze-channel", "update-own-message", "send-reaction", "update-any-message", "flag-message", "read-events", "leave-channel", "typing-events", "delete-channel", "send-typing-events", "update-channel", "search-messages", "pin-message", "delete-any-message", "quote-message", "send-reply", "delete-own-message", "mute-channel", "send-custom-events", "set-channel-cooldown", "upload-file", "join-channel", "update-channel-members", "ban-channel-members", "connect-events", "send-message" ], "hidden": false, "name": "iOS Test" }, "messages": [ { "id": "31DDC161-A9CD-4DFE-A883-750B47A7A8F7", "text": "Hi", "html": "<p>Hi</p>\n", "type": "regular", "user": { "id": "luke_skywalker", "role": "user", "created_at": "2020-12-07T11:36:47.059906Z", "updated_at": "2022-03-08T10:24:54.481883Z", "last_active": "2022-03-08T10:12:36.42996Z", "banned": false, "online": true, "extraData": {}, "name": "Luke Skywalker", "testing-this": 3.14, "testing": false, "birthland": "Tatooine", "yetAnotherField": "40", "image_url": "https://vignette.wikia.nocookie.net/starwars/images/2/20/LukeTLJ.jpg", "extra_data": {}, "image": "https://bit.ly/2TIt8NR" }, "attachments": [], "latest_reactions": [], "own_reactions": [], "reaction_counts": {}, "reaction_scores": {}, "reply_count": 0, "cid": "messaging:71150353-D", "created_at": "2021-07-26T06:38:53.696671Z", "updated_at": "2021-07-26T06:38:53.696671Z", "shadowed": false, "mentioned_users": [], "silent": false, "pinned": false, "pinned_at": null, "pinned_by": null, "pin_expires": null }, { "id": "268723AC-217A-4A85-B65B-984B91C5B61D", "text": "Hello World", "html": "<p>Hello World</p>\n", "type": "regular", "user": { "id": "luke_skywalker", "role": "user", "created_at": "2020-12-07T11:36:47.059906Z", "updated_at": "2022-03-08T10:24:54.481883Z", "last_active": "2022-03-08T10:12:36.42996Z", "banned": false, "online": true, "yetAnotherField": "40", "image_url": "https://vignette.wikia.nocookie.net/starwars/images/2/20/LukeTLJ.jpg", "extra_data": {}, "image": "https://bit.ly/2TIt8NR", "name": "Luke Skywalker", "testing-this": 3.14, "testing": false, "birthland": "Tatooine", "extraData": {} }, "attachments": [], "latest_reactions": [], "own_reactions": [], "reaction_counts": {}, "reaction_scores": {}, "reply_count": 0, "cid": "messaging:71150353-D", "created_at": "2021-07-26T06:50:31.717583Z", "updated_at": "2021-07-26T06:50:31.717583Z", "shadowed": false, "mentioned_users": [], "silent": false, "pinned": false, "pinned_at": null, "pinned_by": null, "pin_expires": null }, { "id": "0375EBB1-D2DC-4D4A-8CD4-9D3D0F82F03A", "text": "Hello new world!", "html": "<p>Hello new world!</p>\n", "type": "regular", "user": { "id": "luke_skywalker", "role": "user", "created_at": "2020-12-07T11:36:47.059906Z", "updated_at": "2022-03-08T10:24:54.481883Z", "last_active": "2022-03-08T10:12:36.42996Z", "banned": false, "online": true, "extra_data": {}, "image": "https://bit.ly/2TIt8NR", "yetAnotherField": "40", "image_url": "https://vignette.wikia.nocookie.net/starwars/images/2/20/LukeTLJ.jpg", "testing": false, "birthland": "Tatooine", "extraData": {}, "name": "Luke Skywalker", "testing-this": 3.14 }, "attachments": [], "latest_reactions": [], "own_reactions": [], "reaction_counts": {}, "reaction_scores": {}, "reply_count": 0, "cid": "messaging:71150353-D", "created_at": "2021-07-26T06:51:15.402474Z", "updated_at": "2021-07-26T06:51:15.402474Z", "shadowed": false, "mentioned_users": [], "silent": false, "pinned": false, "pinned_at": null, "pinned_by": null, "pin_expires": null }, { "id": "FDA2E9C0-E278-4408-BE24-27853FA4E690", "text": "Brave new world!", "html": "<p>Brave new world!</p>\n", "type": "regular", "user": { "id": "luke_skywalker", "role": "user", "created_at": "2020-12-07T11:36:47.059906Z", "updated_at": "2022-03-08T10:24:54.481883Z", "last_active": "2022-03-08T10:12:36.42996Z", "banned": false, "online": true, "name": "Luke Skywalker", "testing-this": 3.14, "testing": false, "birthland": "Tatooine", "extraData": {}, "yetAnotherField": "40", "image_url": "https://vignette.wikia.nocookie.net/starwars/images/2/20/LukeTLJ.jpg", "extra_data": {}, "image": "https://bit.ly/2TIt8NR" }, "attachments": [], "latest_reactions": [ { "message_id": "FDA2E9C0-E278-4408-BE24-27853FA4E690", "user_id": "luke_skywalker", "user": { "id": "luke_skywalker", "role": "user", "created_at": "2020-12-07T11:36:47.059906Z", "updated_at": "2022-03-08T10:24:54.481883Z", "last_active": "2022-03-08T10:12:36.42996Z", "banned": false, "online": true, "extra_data": {}, "image": "https://bit.ly/2TIt8NR", "image_url": "https://vignette.wikia.nocookie.net/starwars/images/2/20/LukeTLJ.jpg", "testing": false, "birthland": "Tatooine", "extraData": {}, "name": "Luke Skywalker", "testing-this": 3.14, "yetAnotherField": "40" }, "type": "love", "score": 1, "created_at": "2021-07-26T11:09:38.231463Z", "updated_at": "2021-07-26T11:09:38.231463Z", "enforce_unique": false } ], "own_reactions": [ { "message_id": "FDA2E9C0-E278-4408-BE24-27853FA4E690", "user_id": "luke_skywalker", "user": { "id": "luke_skywalker", "role": "user", "created_at": "2020-12-07T11:36:47.059906Z", "updated_at": "2022-03-08T10:24:54.481883Z", "last_active": "2022-03-08T10:12:36.42996Z", "banned": false, "online": true, "extra_data": {}, "image": "https://bit.ly/2TIt8NR", "image_url": "https://vignette.wikia.nocookie.net/starwars/images/2/20/LukeTLJ.jpg", "testing": false, "birthland": "Tatooine", "extraData": {}, "name": "Luke Skywalker", "testing-this": 3.14, "yetAnotherField": "40" }, "type": "love", "score": 1, "created_at": "2021-07-26T11:09:38.231463Z", "updated_at": "2021-07-26T11:09:38.231463Z", "enforce_unique": false } ], "reaction_counts": { "love": 1 }, "reaction_scores": { "love": 1 }, "reply_count": 0, "cid": "messaging:71150353-D", "created_at": "2021-07-26T06:52:17.466499Z", "updated_at": "2021-07-26T11:09:38.231463Z", "shadowed": false, "mentioned_users": [], "silent": false, "pinned": false, "pinned_at": null, "pinned_by": null, "pin_expires": null }, { "id": "78F2CD57-7B88-4F2F-A05B-CE297549534A", "text": "Wow world", "html": "<p>Wow world</p>\n", "type": "regular", "user": { "id": "luke_skywalker", "role": "user", "created_at": "2020-12-07T11:36:47.059906Z", "updated_at": "2022-03-08T10:24:54.481883Z", "last_active": "2022-03-08T10:12:36.42996Z", "banned": false, "online": true, "yetAnotherField": "40", "image_url": "https://vignette.wikia.nocookie.net/starwars/images/2/20/LukeTLJ.jpg", "extra_data": {}, "image": "https://bit.ly/2TIt8NR", "name": "Luke Skywalker", "testing-this": 3.14, "testing": false, "birthland": "Tatooine", "extraData": {} }, "attachments": [], "latest_reactions": [], "own_reactions": [], "reaction_counts": {}, "reaction_scores": {}, "reply_count": 0, "cid": "messaging:71150353-D", "created_at": "2021-12-14T13:12:34.489Z", "updated_at": "2021-12-14T13:12:34.489Z", "shadowed": false, "mentioned_users": [], "silent": false, "pinned": false, "pinned_at": null, "pinned_by": null, "pin_expires": null }, { "id": "794AAE62-0994-4239-A4D0-D43E0E8CF0B2", "text": "Sadas", "html": "<p>Sadas</p>\n", "type": "regular", "user": { "id": "luke_skywalker", "role": "user", "created_at": "2020-12-07T11:36:47.059906Z", "updated_at": "2022-03-08T10:24:54.481883Z", "last_active": "2022-03-08T10:12:36.42996Z", "banned": false, "online": true, "testing-this": 3.14, "testing": false, "birthland": "Tatooine", "extraData": {}, "name": "Luke Skywalker", "image_url": "https://vignette.wikia.nocookie.net/starwars/images/2/20/LukeTLJ.jpg", "extra_data": {}, "image": "https://bit.ly/2TIt8NR", "yetAnotherField": "40" }, "attachments": [], "latest_reactions": [], "own_reactions": [], "reaction_counts": {}, "reaction_scores": {}, "reply_count": 0, "cid": "messaging:71150353-D", "created_at": "2021-12-14T13:49:23.57Z", "updated_at": "2021-12-14T13:49:23.57Z", "shadowed": false, "mentioned_users": [], "silent": false, "pinned": false, "pinned_at": null, "pinned_by": null, "pin_expires": null } ], "pinned_messages": [], "watcher_count": 1, "read": [ { "user": { "id": "3Ru9EOTmTglKT8Y0onNs1", "role": "user", "created_at": "2021-06-29T13:29:30.469306Z", "updated_at": "2021-06-29T13:29:31.910574Z", "banned": false, "online": false, "name": "Alexandria", "image": "https://cdn.fakercloud.com/avatars/bagawarman_128.jpg" }, "last_read": "2021-12-14T13:12:34.488499968Z", "unread_messages": 2 }, { "user": { "id": "luke_skywalker", "role": "user", "created_at": "2020-12-07T11:36:47.059906Z", "updated_at": "2022-03-08T10:24:54.481883Z", "last_active": "2022-03-08T10:12:36.42996Z", "banned": false, "online": true, "name": "Luke Skywalker", "testing-this": 3.14, "testing": false, "birthland": "Tatooine", "extraData": {}, "yetAnotherField": "40", "image_url": "https://vignette.wikia.nocookie.net/starwars/images/2/20/LukeTLJ.jpg", "extra_data": {}, "image": "https://bit.ly/2TIt8NR" }, "last_read": "2021-12-14T13:49:23.57Z", "unread_messages": 0 } ], "members": [ { "user_id": "3Ru9EOTmTglKT8Y0onNs1", "user": { "id": "3Ru9EOTmTglKT8Y0onNs1", "role": "user", "created_at": "2021-06-29T13:29:30.469306Z", "updated_at": "2021-06-29T13:29:31.910574Z", "banned": false, "online": false, "name": "Alexandria", "image": "https://cdn.fakercloud.com/avatars/bagawarman_128.jpg" }, "created_at": "2021-07-26T06:38:29.346084Z", "updated_at": "2021-07-26T06:38:29.346084Z", "banned": false, "shadow_banned": false, "role": "member", "channel_role": "channel_member" }, { "user_id": "luke_skywalker", "user": { "id": "luke_skywalker", "role": "user", "created_at": "2020-12-07T11:36:47.059906Z", "updated_at": "2022-03-08T10:24:54.481883Z", "last_active": "2022-03-08T10:12:36.42996Z", "banned": false, "online": true, "yetAnotherField": "40", "image_url": "https://vignette.wikia.nocookie.net/starwars/images/2/20/LukeTLJ.jpg", "testing": false, "birthland": "Tatooine", "extraData": {}, "name": "Luke Skywalker", "testing-this": 3.14, "extra_data": {}, "image": "https://bit.ly/2TIt8NR" }, "created_at": "2021-07-26T06:38:29.346084Z", "updated_at": "2021-07-26T06:38:29.346084Z", "banned": false, "shadow_banned": false, "role": "owner", "channel_role": "channel_member" } ], "membership": { "user": { "id": "luke_skywalker", "role": "user", "created_at": "2020-12-07T11:36:47.059906Z", "updated_at": "2022-03-08T10:24:54.481883Z", "last_active": "2022-03-08T10:12:36.42996Z", "banned": false, "online": true, "yetAnotherField": "40", "image_url": "https://vignette.wikia.nocookie.net/starwars/images/2/20/LukeTLJ.jpg", "testing": false, "birthland": "Tatooine", "extraData": {}, "name": "Luke Skywalker", "testing-this": 3.14, "extra_data": {}, "image": "https://bit.ly/2TIt8NR" }, "created_at": "2021-07-26T06:38:29.346084Z", "updated_at": "2021-07-26T06:38:29.346084Z", "banned": false, "shadow_banned": false, "role": "owner", "channel_role": "channel_member" }, "duration": "9.18ms" }
            """))
        }
        server["/channels"] = { _ in
            .ok(.text("""
            { "channels": [ { "channel": { "id": "!members-wNloUV_XWXLzvdpnv16TPxSns8ooJ2uVRbuZExPBX_I", "type": "messaging", "cid": "messaging:!members-wNloUV_XWXLzvdpnv16TPxSns8ooJ2uVRbuZExPBX_I", "last_message_at": "2022-03-02T17:01:58.001583Z", "created_at": "2021-11-22T16:27:24.321304Z", "updated_at": "2021-11-22T16:27:24.321304Z", "created_by": { "id": "luke_skywalker", "role": "user", "created_at": "2020-12-07T11:36:47.059906Z", "updated_at": "2022-03-03T16:18:53.066662Z", "last_active": "2022-03-03T17:07:11.343006899Z", "banned": false, "online": false, "extraData": {}, "testing-this": 3.14, "name": "Luke Skywalker", "testing": false, "extra_data": {}, "yetAnotherField": "40", "image": "https://vignette.wikia.nocookie.net/starwars/images/2/20/LukeTLJ.jpg", "image_url": "https://vignette.wikia.nocookie.net/starwars/images/2/20/LukeTLJ.jpg", "birthland": "Tatooine" }, "frozen": false, "disabled": false, "member_count": 3, "config": { "created_at": "2021-03-01T19:26:18.406502Z", "updated_at": "2021-09-01T17:42:21.99149Z", "name": "messaging", "typing_events": true, "read_events": true, "connect_events": true, "search": true, "reactions": true, "replies": true, "quotes": true, "mutes": true, "uploads": true, "url_enrichment": true, "custom_events": true, "push_notifications": true, "message_retention": "infinite", "max_message_length": 5000, "automod": "AI", "automod_behavior": "block", "blocklist": "profanity_en_2020_v1", "blocklist_behavior": "block", "automod_thresholds": { "explicit": { "flag": 0.85, "block": 0.9 }, "spam": { "flag": 0.85, "block": 0.9 }, "toxic": { "flag": 0.85, "block": 0.9 } }, "commands": [ { "name": "giphy", "description": "Post a random gif to the channel", "args": "[text]", "set": "fun_set" } ] }, "own_capabilities": [ "flag-message", "connect-events", "send-message", "leave-channel", "delete-own-message", "upload-file", "pin-message", "update-channel", "send-custom-events", "send-reaction", "freeze-channel", "update-any-message", "search-messages", "update-own-message", "typing-events", "send-links", "join-channel", "send-typing-events", "ban-channel-members", "read-events", "send-reply", "delete-channel", "mute-channel", "set-channel-cooldown", "delete-any-message", "quote-message" ], "hidden": false }, "messages": [ { "id": "EB2CF924-533F-4D08-8FC6-4FB9472CEEA1", "text": "Hey", "html": "<p>Hey</p>", "type": "regular", "user": { "id": "luke_skywalker", "role": "user", "created_at": "2020-12-07T11:36:47.059906Z", "updated_at": "2022-03-03T16:18:53.066662Z", "last_active": "2022-03-03T17:07:11.343006899Z", "banned": false, "online": false, "name": "Luke Skywalker", "testing": false, "extra_data": {}, "yetAnotherField": "40", "image": "https://vignette.wikia.nocookie.net/starwars/images/2/20/LukeTLJ.jpg", "testing-this": 3.14, "image_url": "https://vignette.wikia.nocookie.net/starwars/images/2/20/LukeTLJ.jpg", "birthland": "Tatooine", "extraData": {} }, "attachments": [], "latest_reactions": [], "own_reactions": [], "reaction_counts": {}, "reaction_scores": {}, "reply_count": 0, "cid": "messaging:!members-wNloUV_XWXLzvdpnv16TPxSns8ooJ2uVRbuZExPBX_I", "created_at": "2021-11-22T16:27:30.646Z", "updated_at": "2021-11-22T16:27:30.646Z", "shadowed": false, "mentioned_users": [], "silent": false, "pinned": false, "pinned_at": null, "pinned_by": null, "pin_expires": null } ], "pinned_messages": [], "watcher_count": 1, "read": [ { "user": { "id": "han_solo", "role": "user", "created_at": "2020-12-07T11:37:34.230369Z", "updated_at": "2022-02-21T17:19:11.835801Z", "last_active": "2022-03-03T17:09:09.086970981Z", "banned": false, "online": true, "name": "Han Solo", "image": "https://vignette.wikia.nocookie.net/starwars/images/e/e2/TFAHanSolo.png", "birthland": "Corellia", "extraData": {}, "image_url": "https://vignette.wikia.nocookie.net/starwars/images/e/e2/TFAHanSolo.png" }, "last_read": "2022-03-02T01:34:14.236254976Z", "unread_messages": 4 }, { "user": { "id": "luke_skywalker", "role": "user", "created_at": "2020-12-07T11:36:47.059906Z", "updated_at": "2022-03-03T16:18:53.066662Z", "last_active": "2022-03-03T17:07:11.343006899Z", "banned": false, "online": false, "image_url": "https://vignette.wikia.nocookie.net/starwars/images/2/20/LukeTLJ.jpg", "birthland": "Tatooine", "extraData": {}, "testing-this": 3.14, "extra_data": {}, "yetAnotherField": "40", "image": "https://vignette.wikia.nocookie.net/starwars/images/2/20/LukeTLJ.jpg", "name": "Luke Skywalker", "testing": false }, "last_read": "2022-03-02T17:01:58.001583Z", "unread_messages": 0 }, { "user": { "id": "necundefinedMnHdvuD99dh8Iy0g0", "role": "user", "created_at": "2021-06-29T13:02:11.761796Z", "updated_at": "2021-06-29T13:02:24.325735Z", "banned": false, "online": false, "name": "Adella", "image": "https://cdn.fakercloud.com/avatars/buddhasource_128.jpg" }, "last_read": "2022-03-02T01:34:14.236254976Z", "unread_messages": 4 } ], "members": [ { "user_id": "han_solo", "user": { "id": "han_solo", "role": "user", "created_at": "2020-12-07T11:37:34.230369Z", "updated_at": "2022-02-21T17:19:11.835801Z", "last_active": "2022-03-03T17:09:09.086970981Z", "banned": false, "online": true, "image_url": "https://vignette.wikia.nocookie.net/starwars/images/e/e2/TFAHanSolo.png", "name": "Han Solo", "image": "https://vignette.wikia.nocookie.net/starwars/images/e/e2/TFAHanSolo.png", "birthland": "Corellia", "extraData": {} }, "created_at": "2021-11-22T16:27:24.326024Z", "updated_at": "2021-11-22T16:27:24.326024Z", "banned": false, "shadow_banned": false, "role": "member", "channel_role": "channel_member" }, { "user_id": "luke_skywalker", "user": { "id": "luke_skywalker", "role": "user", "created_at": "2020-12-07T11:36:47.059906Z", "updated_at": "2022-03-03T16:18:53.066662Z", "last_active": "2022-03-03T17:07:11.343006899Z", "banned": false, "online": false, "image_url": "https://vignette.wikia.nocookie.net/starwars/images/2/20/LukeTLJ.jpg", "birthland": "Tatooine", "extraData": {}, "testing-this": 3.14, "extra_data": {}, "yetAnotherField": "40", "image": "https://vignette.wikia.nocookie.net/starwars/images/2/20/LukeTLJ.jpg", "name": "Luke Skywalker", "testing": false }, "created_at": "2021-11-22T16:27:24.326024Z", "updated_at": "2021-11-22T16:27:24.326024Z", "banned": false, "shadow_banned": false, "role": "owner", "channel_role": "channel_member" }, { "user_id": "necundefinedMnHdvuD99dh8Iy0g0", "user": { "id": "necundefinedMnHdvuD99dh8Iy0g0", "role": "user", "created_at": "2021-06-29T13:02:11.761796Z", "updated_at": "2021-06-29T13:02:24.325735Z", "banned": false, "online": false, "image": "https://cdn.fakercloud.com/avatars/buddhasource_128.jpg", "name": "Adella" }, "created_at": "2021-11-22T16:27:24.326024Z", "updated_at": "2021-11-22T16:27:24.326024Z", "banned": false, "shadow_banned": false, "role": "member", "channel_role": "channel_member" } ], "membership": { "user": { "id": "han_solo", "role": "user", "created_at": "2020-12-07T11:37:34.230369Z", "updated_at": "2022-02-21T17:19:11.835801Z", "last_active": "2022-03-03T17:09:09.086970981Z", "banned": false, "online": true, "name": "Han Solo", "image": "https://vignette.wikia.nocookie.net/starwars/images/e/e2/TFAHanSolo.png", "birthland": "Corellia", "extraData": {}, "image_url": "https://vignette.wikia.nocookie.net/starwars/images/e/e2/TFAHanSolo.png" }, "created_at": "2021-11-22T16:27:24.326024Z", "updated_at": "2021-11-22T16:27:24.326024Z", "banned": false, "shadow_banned": false, "role": "channel_member", "channel_role": "channel_member" } } ], "duration": "115.56ms" }
            """))
        }
    }
    
    func sendMessage() {
        session.writeText("""
        { "user": { "id": "c-3po", "banned": false, "extraData": {}, "last_active": "2022-03-08T16:29:45.700744439Z", "created_at": "2020-12-07T11:37:35.550588Z", "image_url": "https://vignette.wikia.nocookie.net/starwars/images/3/3f/C-3PO_TLJ_Card_Trader_Award_Card.png", "image": "https://vignette.wikia.nocookie.net/starwars/images/3/3f/C-3PO_TLJ_Card_Trader_Award_Card.png", "updated_at": "2022-02-23T15:02:04.715663Z", "birthland": "Affa", "role": "user", "online": true, "name": "C-3PO" }, "watcher_count": 3, "channel_type": "messaging", "channel_id": "71150333-D", "created_at": "2022-03-08T16:35:01.298719121Z", "message": { "updated_at": "2022-03-08T16:35:01.267876Z", "reply_count": 0, "html": "<p>Testtest</p>\n", "type": "regular", "own_reactions": [], "cid": "messaging:4101B3B5-0", "id": "0F1C1003-B599-44F6-B690-617B836B9450", "user": { "id": "c-3po", "banned": false, "extraData": {}, "last_active": "2022-03-08T16:29:45.700744439Z", "created_at": "2020-12-07T11:37:35.550588Z", "image_url": "https://vignette.wikia.nocookie.net/starwars/images/3/3f/C-3PO_TLJ_Card_Trader_Award_Card.png", "image": "https://vignette.wikia.nocookie.net/starwars/images/3/3f/C-3PO_TLJ_Card_Trader_Award_Card.png", "updated_at": "2022-02-23T15:02:04.715663Z", "birthland": "Affa", "role": "user", "online": true, "name": "C-3PO" }, "shadowed": false, "pinned_at": null, "pin_expires": null, "attachments": [], "reaction_counts": {}, "reaction_scores": {}, "silent": false, "text": "Testtest", "pinned_by": null, "created_at": "2022-03-08T16:35:01.267876Z", "mentioned_users": [], "pinned": false, "latest_reactions": [] }, "type": "message.new", "cid": "messaging:4101B3B5-0" }
        """)
    }
}
